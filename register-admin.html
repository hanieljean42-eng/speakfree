<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription Administrateur - SpeakFree</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .form-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #dc3545;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .success-message, .error-message {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .school-search {
            position: relative;
        }

        .school-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .school-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.3s;
        }

        .school-result-item:hover {
            background: #f8f9fa;
        }

        .school-result-item:last-child {
            border-bottom: none;
        }

        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }

        .warning {
            background: #f8d7da;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üë®‚Äçüíº Inscription Administrateur</h1>
            <p>Cr√©ez votre compte administrateur pour g√©rer votre √©tablissement</p>
        </div>

        <div class="form-container">
            <div class="info-section">
                <strong>üîê Acc√®s Administrateur SpeakFree</strong><br>
                Cette inscription est r√©serv√©e aux responsables d'√©tablissements scolaires qui souhaitent g√©rer les signalements de leur √©cole.
                <br><br>
                <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <strong>‚úÖ Apr√®s inscription, vous pourrez :</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Acc√©der au tableau de bord administrateur</li>
                        <li>G√©rer tous les signalements de votre √©cole</li>
                        <li>R√©pondre de mani√®re anonyme aux signaleurs</li>
                        <li>G√©rer les utilisateurs de votre √©tablissement</li>
                        <li>Consulter les statistiques d√©taill√©es</li>
                        <li>R√©v√©ler l'identit√© en cas de situation grave</li>
                    </ul>
                </div>
            </div>

            <form id="adminRegistrationForm">
                <!-- S√©lection de l'√©cole -->
                <div class="form-section">
                    <h3>üè´ Votre √âtablissement</h3>
                    
                    <div class="highlight">
                        <strong>üìã Important :</strong> Vous devez √™tre associ√© √† une √©cole d√©j√† enregistr√©e dans SpeakFree. 
                        Si votre √©cole n'est pas encore inscrite, veuillez d'abord 
                        <a href="register-school.html" style="color: #667eea; font-weight: bold;">cr√©er votre √©tablissement</a>.
                    </div>

                    <div class="form-group school-search">
                        <label for="schoolSearch">Rechercher votre √©cole <span class="required">*</span></label>
                        <input type="text" id="schoolSearch" name="schoolSearch" required 
                               placeholder="Tapez le nom de votre √©cole ou son code..."
                               onkeyup="searchSchools()" autocomplete="off">
                        <div id="schoolResults" class="school-results"></div>
                        <input type="hidden" id="selectedSchoolId" name="schoolId" required>
                    </div>

                    <div id="selectedSchoolInfo" style="display: none; background: #e7f3ff; padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <h4 style="color: #0066cc; margin-bottom: 10px;">√âcole s√©lectionn√©e :</h4>
                        <div id="schoolInfoDisplay"></div>
                    </div>
                </div>

                <!-- Informations personnelles -->
                <div class="form-section">
                    <h3>üë§ Vos Informations Personnelles</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Pr√©nom <span class="required">*</span></label>
                            <input type="text" id="firstName" name="firstName" required 
                                   placeholder="Votre pr√©nom">
                        </div>
                        
                        <div class="form-group">
                            <label for="lastName">Nom de famille <span class="required">*</span></label>
                            <input type="text" id="lastName" name="lastName" required 
                                   placeholder="Votre nom de famille">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="position">Fonction dans l'√©tablissement <span class="required">*</span></label>
                        <select id="position" name="position" required>
                            <option value="">-- S√©lectionnez votre fonction --</option>
                            <option value="directeur">Directeur/Directrice</option>
                            <option value="proviseur">Proviseur</option>
                            <option value="principal">Principal(e)</option>
                            <option value="adjoint">Directeur/Directrice Adjoint(e)</option>
                            <option value="surveillant_general">Surveillant(e) G√©n√©ral(e)</option>
                            <option value="conseiller_education">Conseiller/Conseill√®re d'√âducation</option>
                            <option value="responsable_discipline">Responsable Discipline</option>
                            <option value="coordinateur">Coordinateur/Coordinatrice</option>
                            <option value="autre">Autre fonction administrative</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email professionnel <span class="required">*</span></label>
                            <input type="email" id="email" name="email" required 
                                   placeholder="votre.email@ecole.ci">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">T√©l√©phone <span class="required">*</span></label>
                            <input type="tel" id="phone" name="phone" required 
                                   placeholder="+225 XX XX XX XX XX">
                        </div>
                    </div>
                </div>

                <!-- Informations de connexion -->
                <div class="form-section">
                    <h3>üîê Informations de Connexion</h3>
                    
                    <div class="form-group">
                        <label for="username">Nom d'utilisateur <span class="required">*</span></label>
                        <input type="text" id="username" name="username" required 
                               placeholder="Choisissez un nom d'utilisateur unique"
                               onblur="checkUsernameAvailability()">
                        <small id="usernameStatus" style="margin-top: 5px; display: block;"></small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="password">Mot de passe <span class="required">*</span></label>
                            <input type="password" id="password" name="password" required 
                                   placeholder="Minimum 8 caract√®res"
                                   onkeyup="checkPasswordStrength()">
                            <small id="passwordStrength" style="margin-top: 5px; display: block;"></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirmPassword">Confirmer le mot de passe <span class="required">*</span></label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required 
                                   placeholder="R√©p√©tez votre mot de passe"
                                   onkeyup="checkPasswordMatch()">
                            <small id="passwordMatch" style="margin-top: 5px; display: block;"></small>
                        </div>
                    </div>
                </div>

                <!-- Justification -->
                <div class="form-section">
                    <h3>üìù Justification de la Demande</h3>
                    
                    <div class="form-group">
                        <label for="justification">Pourquoi demandez-vous l'acc√®s administrateur ? <span class="required">*</span></label>
                        <textarea id="justification" name="justification" rows="4" required 
                                  placeholder="Expliquez bri√®vement votre r√¥le dans l'√©tablissement et pourquoi vous avez besoin d'un acc√®s administrateur..."></textarea>
                        <small style="color: #666;">Cette justification sera examin√©e lors de la validation de votre demande.</small>
                    </div>
                </div>

                <!-- Conditions -->
                <div class="warning">
                    <h4 style="color: #721c24; margin-bottom: 15px;">‚ö†Ô∏è Conditions d'Utilisation</h4>
                    <div style="max-height: 150px; overflow-y: auto; background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>En tant qu'administrateur, vous vous engagez √† :</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Traiter tous les signalements de mani√®re confidentielle et professionnelle</li>
                            <li>Respecter l'anonymat des signaleurs sauf cas exceptionnels pr√©vus par la loi</li>
                            <li>Ne pas utiliser les informations √† des fins personnelles ou malveillantes</li>
                            <li>R√©pondre dans des d√©lais raisonnables aux signalements</li>
                            <li>Maintenir la s√©curit√© de votre compte (mot de passe, acc√®s)</li>
                            <li>Signaler tout usage abusif ou tentative de piratage</li>
                            <li>Respecter la l√©gislation ivoirienne en vigueur</li>
                        </ul>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="acceptTerms" name="acceptTerms" required style="margin-right: 10px; width: auto;">
                            <span>J'accepte les conditions d'utilisation et je m'engage √† respecter mes responsabilit√©s d'administrateur <span class="required">*</span></span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    üì§ Soumettre la demande d'inscription
                </button>
            </form>

            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>
        </div>
    </div>

    <script>
        let schoolsData = [];
        let selectedSchool = null;

        // Charger les √©coles disponibles
        async function loadSchools() {
            try {
                const response = await fetch('/api/schools');
                const result = await response.json();
                if (result.success) {
                    schoolsData = result.schools;
                }
            } catch (error) {
                console.error('Erreur lors du chargement des √©coles:', error);
            }
        }

        // Rechercher les √©coles
        function searchSchools() {
            const searchTerm = document.getElementById('schoolSearch').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('schoolResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const filteredSchools = schoolsData.filter(school => 
                school.name.toLowerCase().includes(searchTerm) ||
                (school.school_code && school.school_code.toLowerCase().includes(searchTerm)) ||
                (school.city && school.city.toLowerCase().includes(searchTerm))
            );

            if (filteredSchools.length === 0) {
                resultsDiv.innerHTML = '<div class="school-result-item">Aucune √©cole trouv√©e</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            resultsDiv.innerHTML = filteredSchools.slice(0, 5).map(school => `
                <div class="school-result-item" onclick="selectSchool(${school.id}, '${school.name}', '${school.school_code}', '${school.city || ''}', '${school.school_type || ''}')">
                    <strong>${school.name}</strong>
                    ${school.school_code ? `<span style="background: #f0f8ff; color: #0066cc; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 10px;">${school.school_code}</span>` : ''}
                    ${school.city ? `<br><small style="color: #666;">${school.city}</small>` : ''}
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
        }

        // S√©lectionner une √©cole
        function selectSchool(id, name, code, city, type) {
            selectedSchool = { id, name, code, city, type };
            
            document.getElementById('schoolSearch').value = name;
            document.getElementById('selectedSchoolId').value = id;
            document.getElementById('schoolResults').style.display = 'none';
            
            // Afficher les informations de l'√©cole s√©lectionn√©e
            const infoDiv = document.getElementById('schoolInfoDisplay');
            infoDiv.innerHTML = `
                <p><strong>Nom :</strong> ${name}</p>
                ${code ? `<p><strong>Code :</strong> <span style="font-family: monospace; background: #f0f8ff; padding: 2px 6px; border-radius: 5px;">${code}</span></p>` : ''}
                ${city ? `<p><strong>Ville :</strong> ${city}</p>` : ''}
                ${type ? `<p><strong>Type :</strong> ${getSchoolTypeLabel(type)}</p>` : ''}
            `;
            
            document.getElementById('selectedSchoolInfo').style.display = 'block';
        }

        // Obtenir le libell√© du type d'√©cole
        function getSchoolTypeLabel(type) {
            const labels = {
                'public': 'Public',
                'prive': 'Priv√©',
                'confessionnel': 'Confessionnel',
                'international': 'International'
            };
            return labels[type] || type;
        }

        // V√©rifier la disponibilit√© du nom d'utilisateur
        async function checkUsernameAvailability() {
            const username = document.getElementById('username').value.trim();
            const statusDiv = document.getElementById('usernameStatus');
            
            if (username.length < 3) {
                statusDiv.textContent = 'Le nom d\'utilisateur doit contenir au moins 3 caract√®res';
                statusDiv.style.color = '#dc3545';
                return;
            }

            try {
                const response = await fetch(`/api/auth/check-username?username=${encodeURIComponent(username)}`);
                const result = await response.json();
                
                if (result.available) {
                    statusDiv.textContent = '‚úÖ Nom d\'utilisateur disponible';
                    statusDiv.style.color = '#28a745';
                } else {
                    statusDiv.textContent = '‚ùå Ce nom d\'utilisateur est d√©j√† pris';
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                statusDiv.textContent = 'Erreur lors de la v√©rification';
                statusDiv.style.color = '#dc3545';
            }
        }

        // V√©rifier la force du mot de passe
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthDiv.textContent = '';
                return;
            }

            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength++;
            else feedback.push('au moins 8 caract√®res');

            if (/[a-z]/.test(password)) strength++;
            else feedback.push('une minuscule');

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('une majuscule');

            if (/[0-9]/.test(password)) strength++;
            else feedback.push('un chiffre');

            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            else feedback.push('un caract√®re sp√©cial');

            const levels = ['Tr√®s faible', 'Faible', 'Moyen', 'Fort', 'Tr√®s fort'];
            const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'];

            strengthDiv.textContent = `Force: ${levels[strength]} ${feedback.length > 0 ? '(Manque: ' + feedback.join(', ') + ')' : ''}`;
            strengthDiv.style.color = colors[strength];
        }

        // V√©rifier la correspondance des mots de passe
        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');
            
            if (confirmPassword.length === 0) {
                matchDiv.textContent = '';
                return;
            }

            if (password === confirmPassword) {
                matchDiv.textContent = '‚úÖ Les mots de passe correspondent';
                matchDiv.style.color = '#28a745';
            } else {
                matchDiv.textContent = '‚ùå Les mots de passe ne correspondent pas';
                matchDiv.style.color = '#dc3545';
            }
        }

        // Masquer les r√©sultats quand on clique ailleurs
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.school-search')) {
                document.getElementById('schoolResults').style.display = 'none';
            }
        });

        // Soumission du formulaire
        document.getElementById('adminRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // R√©initialiser les messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            // D√©sactiver le bouton
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Envoi en cours...';

            // Validation c√¥t√© client
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                errorMessage.innerHTML = '<h4>‚ùå Erreur de validation</h4><p>Les mots de passe ne correspondent pas.</p>';
                errorMessage.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Soumettre la demande d\'inscription';
                return;
            }

            if (!selectedSchool) {
                errorMessage.innerHTML = '<h4>‚ùå Erreur de validation</h4><p>Veuillez s√©lectionner une √©cole.</p>';
                errorMessage.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Soumettre la demande d\'inscription';
                return;
            }

            // Pr√©parer les donn√©es
            const formData = {
                schoolId: selectedSchool.id,
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                position: document.getElementById('position').value,
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                username: document.getElementById('username').value.trim(),
                password: password,
                justification: document.getElementById('justification').value.trim()
            };

            try {
                const response = await fetch('/api/auth/register-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    successMessage.innerHTML = `
                        <h4>‚úÖ Demande d'inscription soumise avec succ√®s !</h4>
                        <p><strong>Num√©ro de demande :</strong> ${result.requestId}</p>
                        <p>Votre demande d'acc√®s administrateur a √©t√© enregistr√©e et sera examin√©e par notre √©quipe.</p>
                        <p><strong>Prochaines √©tapes :</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>V√©rification de votre identit√© et de votre fonction</li>
                            <li>Validation par l'√©quipe SpeakFree</li>
                            <li>Notification par email de l'activation de votre compte</li>
                        </ul>
                        <p><strong>D√©lai :</strong> 2-5 jours ouvrables</p>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn" onclick="window.location.href='index.html'" style="display: inline-block; width: auto; padding: 10px 20px;">
                                üè† Retour √† l'accueil
                            </button>
                        </div>
                    `;
                    successMessage.style.display = 'block';
                    
                    // R√©initialiser le formulaire
                    document.getElementById('adminRegistrationForm').reset();
                    document.getElementById('selectedSchoolInfo').style.display = 'none';
                    selectedSchool = null;
                } else {
                    throw new Error(result.message || 'Erreur lors de la soumission');
                }
            } catch (error) {
                console.error('Erreur:', error);
                errorMessage.innerHTML = `
                    <h4>‚ùå Erreur lors de la soumission</h4>
                    <p>${error.message}</p>
                    <p>Veuillez v√©rifier vos informations et r√©essayer.</p>
                `;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth' });
            } finally {
                // R√©activer le bouton
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Soumettre la demande d\'inscription';
            }
        });

        // Initialisation
        loadSchools();
    </script>
</body>
</html>
