<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Super Admin - SpeakFree</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
            color: white;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        .login-box h1 { color: #e74c3c; text-align: center; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-2px); }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-card .number { font-size: 2.5em; font-weight: bold; }
        .stat-card .label { opacity: 0.9; margin-top: 5px; }
        .schools-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            color: #333;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .section-header h2 { color: #e74c3c; }
        .tabs { display: flex; gap: 10px; }
        .tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab.active { background: #e74c3c; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .school-card {
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        .school-card.inactive { border-left-color: #95a5a6; }
        .school-card.pending { border-left-color: #f39c12; }
        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .school-name { font-size: 1.3em; font-weight: bold; color: #2c3e50; }
        .school-code { color: #7f8c8d; font-size: 0.9em; }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-active { background: #27ae60; color: white; }
        .status-inactive { background: #95a5a6; color: white; }
        .status-pending { background: #f39c12; color: white; }
        .school-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item { padding: 8px 0; }
        .info-label { color: #7f8c8d; font-size: 0.9em; }
        .info-value { font-weight: 600; color: #2c3e50; }
        .school-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        .btn-details { background: #3498db; color: white; }
        .btn-deactivate { background: #f39c12; color: #333; }
        .btn-activate { background: #27ae60; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- √âcran de connexion -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>‚öôÔ∏è Super Admin</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Code d'Acc√®s Super Admin</label>
                    <input type="password" class="form-control" id="adminCode" required placeholder="Entrez le code...">
                </div>
                <button type="submit" class="btn">üîì Acc√©der</button>
            </form>
            <p style="text-align: center; margin-top: 20px; color: #666;">
                <a href="/index.html" style="color: #e74c3c;">‚Üê Retour √† l'accueil</a>
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <div>
                    <h1>‚öôÔ∏è Super Admin Panel</h1>
                    <p style="opacity: 0.9;">Gestion globale de la plateforme SpeakFree</p>
                </div>
                <button class="logout-btn" id="logoutBtn">üö™ D√©connexion</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üè´</div>
                    <div class="number" id="activeSchools">0</div>
                    <div class="label">√âcoles Actives</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚è≥</div>
                    <div class="number" id="pendingSchools">0</div>
                    <div class="label">En Attente</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üì¢</div>
                    <div class="number" id="totalReports">0</div>
                    <div class="label">Signalements</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <div class="number" id="totalAdmins">0</div>
                    <div class="label">Administrateurs</div>
                </div>
            </div>

            <div class="schools-container">
                <div class="section-header">
                    <h2>üè´ Gestion des √âcoles</h2>
                    <div class="tabs">
                        <button class="tab active" id="tabPending">‚è≥ En Attente</button>
                        <button class="tab" id="tabActive">‚úÖ Actives</button>
                        <button class="tab" id="tabInactive">‚è∏Ô∏è Inactives</button>
                    </div>
                </div>

                <div class="tab-content active" id="pending"></div>
                <div class="tab-content" id="active"></div>
                <div class="tab-content" id="inactive"></div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        var API_URL = 'http://localhost:3000';
        var SUPER_ADMIN_CODE = '200700';

        // ============ FONCTIONS UTILITAIRES ============
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTab(tabId) {
            // Masquer tous les contenus
            document.querySelectorAll('.tab-content').forEach(function(el) {
                el.classList.remove('active');
            });
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(function(el) {
                el.classList.remove('active');
            });
            // Activer le contenu demand√©
            document.getElementById(tabId).classList.add('active');
            // Activer l'onglet correspondant
            document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
        }

        // ============ FONCTIONS API ============
        function apiGet(endpoint) {
            return fetch(API_URL + endpoint).then(function(r) { return r.json(); });
        }

        function apiPost(endpoint, data) {
            return fetch(API_URL + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); });
        }

        function apiDelete(endpoint, data) {
            return fetch(API_URL + endpoint, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(function(r) { return r.json(); });
        }

        // ============ ACTIONS SUR LES √âCOLES ============
        function voirDetails(schoolId) {
            console.log('voirDetails appel√© avec:', schoolId);
            alert('Chargement des d√©tails...');
            
            apiGet('/api/super-admin/schools/' + schoolId + '/details')
                .then(function(data) {
                    console.log('D√©tails re√ßus:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        var msg = 'üìä D√âTAILS DE L\'√âCOLE\n\n';
                        msg += 'üè´ Nom: ' + data.school.name + '\n';
                        msg += 'üìç Ville: ' + (data.school.city || 'N/A') + '\n';
                        msg += 'üîë Code: ' + data.school.school_code + '\n';
                        msg += 'üë• Admins: ' + (data.admins ? data.admins.length : 0) + '\n';
                        msg += 'üì¢ Signalements r√©cents: ' + (data.recentReports ? data.recentReports.length : 0);
                        alert(msg);
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        function desactiverEcole(schoolId) {
            console.log('desactiverEcole appel√© avec:', schoolId);
            
            if (!confirm('‚è∏Ô∏è D√©sactiver cette √©cole ?\n\nL\'√©cole ne pourra plus se connecter.')) {
                return;
            }
            
            apiPost('/api/super-admin/schools/' + schoolId + '/deactivate', { code: SUPER_ADMIN_CODE })
                .then(function(data) {
                    console.log('R√©ponse:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        alert('‚úÖ ' + data.message);
                        chargerEcolesActives();
                        chargerEcolesInactives();
                        chargerStatistiques();
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        function activerEcole(schoolId) {
            console.log('activerEcole appel√© avec:', schoolId);
            
            if (!confirm('‚úÖ R√©activer cette √©cole ?')) {
                return;
            }
            
            apiPost('/api/super-admin/schools/' + schoolId + '/activate', { code: SUPER_ADMIN_CODE })
                .then(function(data) {
                    console.log('R√©ponse:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        alert('‚úÖ ' + data.message);
                        chargerEcolesActives();
                        chargerEcolesInactives();
                        chargerStatistiques();
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        function supprimerEcole(schoolId) {
            console.log('supprimerEcole appel√© avec:', schoolId);
            
            if (!confirm('‚ö†Ô∏è ATTENTION !\n\nSupprimer cette √©cole supprimera TOUTES ses donn√©es.\n\nCette action est IRR√âVERSIBLE.\n\nContinuer ?')) {
                return;
            }
            
            apiDelete('/api/super-admin/schools/' + schoolId, { code: SUPER_ADMIN_CODE })
                .then(function(data) {
                    console.log('R√©ponse:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        alert('üóëÔ∏è ' + data.message);
                        chargerEcolesActives();
                        chargerEcolesInactives();
                        chargerStatistiques();
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        function approuverEcole(schoolId, schoolName, phone, email) {
            console.log('approuverEcole appel√© avec:', schoolId);
            
            var password = prompt('D√©finissez le mot de passe pour ' + schoolName + ':', '');
            if (!password || password.length < 4) {
                alert('Le mot de passe doit contenir au moins 4 caract√®res.');
                return;
            }
            
            apiPost('/api/super-admin/schools/' + schoolId + '/approve', { 
                code: SUPER_ADMIN_CODE,
                defaultPassword: password 
            })
                .then(function(data) {
                    console.log('R√©ponse:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        alert('‚úÖ √âcole approuv√©e !\n\nCode: ' + data.schoolCode + '\nMot de passe: ' + password);
                        chargerEcolesEnAttente();
                        chargerEcolesActives();
                        chargerStatistiques();
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        function rejeterEcole(schoolId) {
            console.log('rejeterEcole appel√© avec:', schoolId);
            
            var raison = prompt('Raison du rejet (optionnel):', '');
            
            apiPost('/api/super-admin/schools/' + schoolId + '/reject', { 
                code: SUPER_ADMIN_CODE,
                reason: raison || 'Non sp√©cifi√©e'
            })
                .then(function(data) {
                    console.log('R√©ponse:', data);
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                    } else {
                        alert('‚ùå √âcole rejet√©e.');
                        chargerEcolesEnAttente();
                        chargerStatistiques();
                    }
                })
                .catch(function(err) {
                    console.error('Erreur:', err);
                    alert('Erreur: ' + err.message);
                });
        }

        // ============ CHARGEMENT DES DONN√âES ============
        function chargerStatistiques() {
            apiGet('/api/super-admin/stats')
                .then(function(data) {
                    document.getElementById('activeSchools').textContent = data.activeSchools || 0;
                    document.getElementById('pendingSchools').textContent = data.pendingSchools || 0;
                    document.getElementById('totalReports').textContent = data.totalReports || 0;
                    document.getElementById('totalAdmins').textContent = data.totalAdmins || 0;
                })
                .catch(function(err) {
                    console.error('Erreur stats:', err);
                });
        }

        function chargerEcolesEnAttente() {
            apiGet('/api/super-admin/schools/pending')
                .then(function(data) {
                    var container = document.getElementById('pending');
                    
                    if (!data.schools || data.schools.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="icon">‚è≥</div><h3>Aucune demande en attente</h3></div>';
                        return;
                    }
                    
                    var html = '';
                    data.schools.forEach(function(school) {
                        html += '<div class="school-card pending">';
                        html += '<div class="school-header">';
                        html += '<div><div class="school-name">üè´ ' + escapeHtml(school.name) + '</div>';
                        html += '<div class="school-code">Code: ' + escapeHtml(school.school_code) + '</div></div>';
                        html += '<span class="status-badge status-pending">‚è≥ En attente</span>';
                        html += '</div>';
                        html += '<div class="school-info">';
                        html += '<div class="info-item"><span class="info-label">üìç Ville:</span> <span class="info-value">' + escapeHtml(school.city || 'N/A') + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üìß Email:</span> <span class="info-value">' + escapeHtml(school.email) + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üìû T√©l:</span> <span class="info-value">' + escapeHtml(school.phone) + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üë§ Contact:</span> <span class="info-value">' + escapeHtml(school.first_name) + ' ' + escapeHtml(school.last_name) + '</span></div>';
                        html += '</div>';
                        html += '<div class="school-footer">';
                        html += '<div>Type: ' + escapeHtml(school.type) + '</div>';
                        html += '<div class="action-btns">';
                        html += '<button class="btn-action btn-approve" onclick="approuverEcole(' + school.id + ', \'' + escapeHtml(school.name).replace(/'/g, "\\'") + '\', \'' + escapeHtml(school.phone) + '\', \'' + escapeHtml(school.email) + '\')">‚úÖ Approuver</button>';
                        html += '<button class="btn-action btn-reject" onclick="rejeterEcole(' + school.id + ')">‚ùå Rejeter</button>';
                        html += '</div></div></div>';
                    });
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    console.error('Erreur pending:', err);
                    document.getElementById('pending').innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur de chargement</h3></div>';
                });
        }

        function chargerEcolesActives() {
            apiGet('/api/super-admin/schools/active')
                .then(function(data) {
                    var container = document.getElementById('active');
                    
                    if (!data.schools || data.schools.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="icon">üè´</div><h3>Aucune √©cole active</h3></div>';
                        return;
                    }
                    
                    var html = '';
                    data.schools.forEach(function(school) {
                        html += '<div class="school-card">';
                        html += '<div class="school-header">';
                        html += '<div><div class="school-name">üè´ ' + escapeHtml(school.name) + '</div>';
                        html += '<div class="school-code">Code: ' + escapeHtml(school.school_code) + '</div></div>';
                        html += '<span class="status-badge status-active">‚úÖ Active</span>';
                        html += '</div>';
                        html += '<div class="school-info">';
                        html += '<div class="info-item"><span class="info-label">üìç Ville:</span> <span class="info-value">' + escapeHtml(school.city || 'N/A') + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üì¢ Signalements:</span> <span class="info-value">' + (school.report_count || 0) + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üë• Admins:</span> <span class="info-value">' + (school.admin_count || 0) + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üìö Type:</span> <span class="info-value">' + escapeHtml(school.type) + '</span></div>';
                        html += '</div>';
                        html += '<div class="school-footer">';
                        html += '<div>√âl√®ves: ' + (school.student_count || 'N/A') + '</div>';
                        html += '<div class="action-btns">';
                        html += '<button class="btn-action btn-details" onclick="voirDetails(' + school.id + ')">üëÅÔ∏è D√©tails</button>';
                        html += '<button class="btn-action btn-deactivate" onclick="desactiverEcole(' + school.id + ')">‚è∏Ô∏è D√©sactiver</button>';
                        html += '<button class="btn-action btn-delete" onclick="supprimerEcole(' + school.id + ')">üóëÔ∏è Supprimer</button>';
                        html += '</div></div></div>';
                    });
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    console.error('Erreur active:', err);
                    document.getElementById('active').innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur de chargement</h3></div>';
                });
        }

        function chargerEcolesInactives() {
            apiGet('/api/super-admin/schools/inactive')
                .then(function(data) {
                    var container = document.getElementById('inactive');
                    
                    if (!data.schools || data.schools.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="icon">‚è∏Ô∏è</div><h3>Aucune √©cole inactive</h3></div>';
                        return;
                    }
                    
                    var html = '';
                    data.schools.forEach(function(school) {
                        html += '<div class="school-card inactive">';
                        html += '<div class="school-header">';
                        html += '<div><div class="school-name">üè´ ' + escapeHtml(school.name) + '</div>';
                        html += '<div class="school-code">Code: ' + escapeHtml(school.school_code) + '</div></div>';
                        html += '<span class="status-badge status-inactive">‚è∏Ô∏è Inactive</span>';
                        html += '</div>';
                        html += '<div class="school-info">';
                        html += '<div class="info-item"><span class="info-label">üìç Ville:</span> <span class="info-value">' + escapeHtml(school.city || 'N/A') + '</span></div>';
                        html += '<div class="info-item"><span class="info-label">üì¢ Signalements:</span> <span class="info-value">' + (school.report_count || 0) + '</span></div>';
                        html += '</div>';
                        html += '<div class="school-footer">';
                        html += '<div>√âl√®ves: ' + (school.student_count || 'N/A') + '</div>';
                        html += '<div class="action-btns">';
                        html += '<button class="btn-action btn-activate" onclick="activerEcole(' + school.id + ')">‚úÖ R√©activer</button>';
                        html += '<button class="btn-action btn-delete" onclick="supprimerEcole(' + school.id + ')">üóëÔ∏è Supprimer</button>';
                        html += '</div></div></div>';
                    });
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    console.error('Erreur inactive:', err);
                    document.getElementById('inactive').innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur de chargement</h3></div>';
                });
        }

        // ============ INITIALISATION ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page charg√©e');
            
            // Gestion du formulaire de connexion
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                var code = document.getElementById('adminCode').value;
                
                if (code === SUPER_ADMIN_CODE) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    
                    chargerStatistiques();
                    chargerEcolesEnAttente();
                    chargerEcolesActives();
                    chargerEcolesInactives();
                } else {
                    alert('‚ùå Code incorrect !');
                }
            });
            
            // Gestion des onglets
            document.getElementById('tabPending').addEventListener('click', function() { showTab('pending'); });
            document.getElementById('tabActive').addEventListener('click', function() { showTab('active'); });
            document.getElementById('tabInactive').addEventListener('click', function() { showTab('inactive'); });
            
            // Gestion de la d√©connexion
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Se d√©connecter ?')) {
                    document.getElementById('dashboard').classList.remove('active');
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('adminCode').value = '';
                }
            });
        });
    </script>
</body>
</html>
