<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëî Dashboard Admin - SpeakFree</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .menu-item {
            padding: 15px 20px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.2);
        }

        .menu-item .icon {
            font-size: 1.3em;
        }

        .logout-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 15px;
            background: rgba(220,53,69,0.9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #dc3545;
            transform: translateY(-2px);
        }

        .main-content {
            margin-left: 260px;
            padding: 30px;
        }

        .top-bar {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 {
            color: #333;
            font-size: 2em;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-card .label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-card .trend {
            font-size: 0.9em;
            color: #28a745;
            margin-top: 5px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .content-box {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.8em;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn, .action-btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn:hover, .action-btn-primary:hover {
            background: #5568d3;
        }

        .report-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
            cursor: pointer;
        }

        .report-card:hover {
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .report-card.urgent {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .report-code {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .report-date {
            color: #666;
            font-size: 0.9em;
        }

        .report-type {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .type-harcelement {
            background: #ffe6e6;
            color: #dc3545;
        }

        .type-violence {
            background: #fff3cd;
            color: #856404;
        }

        .type-vol {
            background: #d1ecf1;
            color: #0c5460;
        }

        .type-drogue {
            background: #f8d7da;
            color: #721c24;
        }

        .report-description {
            color: #555;
            line-height: 1.6;
            margin: 10px 0;
        }

        .report-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-pending {
            background: #ffc107;
            color: #856404;
        }

        .status-in-progress {
            background: #17a2b8;
            color: white;
        }

        .status-resolved {
            background: #28a745;
            color: white;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-view {
            background: #667eea;
            color: white;
        }

        .btn-view:hover {
            background: #5568d3;
        }

        .btn-reply {
            background: #28a745;
            color: white;
        }

        .btn-reply:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .close-modal {
            font-size: 2em;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #333;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detail-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #333;
            font-size: 1.1em;
        }

        .files-list {
            margin: 20px 0;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .reply-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        select.form-control {
            cursor: pointer;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
                padding: 20px 10px;
            }

            .sidebar-header h2,
            .sidebar-header p,
            .menu-item span {
                display: none;
            }

            .main-content {
                margin-left: 80px;
            }

            .logout-btn span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üí¨ SpeakFree</h2>
            <p>Dashboard Admin</p>
        </div>

        <div class="menu-item active" onclick="showSection('dashboard')">
            <span class="icon">üìä</span>
            <span>Tableau de bord</span>
        </div>

        <div class="menu-item" onclick="showSection('reports')">
            <span class="icon">üì¢</span>
            <span>Signalements</span>
        </div>

        <div class="menu-item" onclick="showSection('discussions')">
            <span class="icon">üí¨</span>
            <span>Discussions</span>
        </div>

        <div class="menu-item" onclick="showSection('statistics')">
            <span class="icon">üìà</span>
            <span>Statistiques</span>
        </div>

        <div class="menu-item" onclick="showSection('team')">
            <span class="icon">üë•</span>
            <span>√âquipe</span>
        </div>

        <div class="menu-item" onclick="showSection('settings')">
            <span class="icon">‚öôÔ∏è</span>
            <span>Param√®tres</span>
        </div>

        <button class="logout-btn" onclick="logout()">
            üö™ <span>D√©connexion</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1 id="pageTitle">Tableau de Bord</h1>
            <div class="admin-info">
                <div style="text-align: right;">
                    <strong style="color: #333;" id="schoolName">Chargement...</strong><br>
                    <small style="color: #666;" id="adminName">Admin</small>
                </div>
                <div class="admin-avatar">üë§</div>
            </div>
        </div>

        <!-- Section: Dashboard -->
        <div class="content-section active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üì¢</div>
                    <div class="number" id="statTotal">-</div>
                    <div class="label">Signalements Totaux</div>
                    <div class="trend">‚Üó Temps r√©el</div>
                </div>

                <div class="stat-card">
                    <div class="icon">‚è≥</div>
                    <div class="number" id="statPending">-</div>
                    <div class="label">En Attente</div>
                    <div class="trend">Action requise</div>
                </div>

                <div class="stat-card">
                    <div class="icon">üîÑ</div>
                    <div class="number" id="statInProgress">-</div>
                    <div class="label">En Cours</div>
                    <div class="trend">En traitement</div>
                </div>

                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <div class="number" id="statResolved">-</div>
                    <div class="label">R√©solus</div>
                    <div class="trend">‚úì Compl√©t√©s</div>
                </div>
            </div>

            <div class="content-box">
                <div class="section-header">
                    <h2>üì¢ Signalements R√©cents</h2>
                    <div class="filter-controls">
                        <button class="filter-btn" onclick="showSection('reports')">Voir tout</button>
                        <button class="action-btn-primary" onclick="refreshData()">üîÑ Actualiser</button>
                    </div>
                </div>

                <div id="recentReportsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des signalements...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Reports -->
        <div class="content-section" id="reports">
            <div class="content-box">
                <div class="section-header">
                    <h2>üì¢ Tous les Signalements</h2>
                    <div class="filter-controls">
                        <select class="filter-btn" id="statusFilter" onchange="filterReports()">
                            <option value="">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="in-progress">En cours</option>
                            <option value="resolved">R√©solus</option>
                        </select>
                        <button class="action-btn-primary" onclick="loadAllReports()">üîÑ Actualiser</button>
                    </div>
                </div>

                <div id="allReportsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Discussions -->
        <div class="content-section" id="discussions">
            <div class="content-box">
                <div class="section-header">
                    <h2>üí¨ Discussions Actives</h2>
                    <button class="action-btn-primary" onclick="loadDiscussions()">üîÑ Actualiser</button>
                </div>

                <div id="discussionsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des discussions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Statistics -->
        <div class="content-section" id="statistics">
            <div class="content-box">
                <div class="section-header">
                    <h2>üìà Statistiques D√©taill√©es</h2>
                    <select class="filter-btn" id="periodFilter" onchange="loadStatistics()">
                        <option value="7">7 derniers jours</option>
                        <option value="30" selected>30 derniers jours</option>
                        <option value="90">90 derniers jours</option>
                        <option value="365">1 an</option>
                    </select>
                </div>

                <div id="statisticsContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des statistiques...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Team -->
        <div class="content-section" id="team">
            <div class="content-box">
                <div class="section-header">
                    <h2>üë• √âquipe Administrative</h2>
                    <button class="action-btn-primary" onclick="loadTeam()">üîÑ Actualiser</button>
                </div>

                <div id="teamList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement de l'√©quipe...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Settings -->
        <div class="content-section" id="settings">
            <div class="content-box">
                <div class="section-header">
                    <h2>‚öôÔ∏è Param√®tres de l'√âcole</h2>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Code √âcole</div>
                        <div class="detail-value" id="settingsSchoolCode">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Nom</div>
                        <div class="detail-value" id="settingsSchoolName">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ville</div>
                        <div class="detail-value" id="settingsCity">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Statut</div>
                        <div class="detail-value"><span class="status-badge status-resolved" id="settingsStatus">Active</span></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Changer le mot de passe</h3>
                    <form id="changePasswordForm" onsubmit="changePassword(event)">
                        <div class="form-group">
                            <label>Mot de passe actuel</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label>Nouveau mot de passe</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Confirmer le nouveau mot de passe</label>
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                        </div>
                        <button type="submit" class="action-btn-primary">üîí Changer le mot de passe</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d√©tail signalement -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√©tails du Signalement</h2>
                <button class="close-modal" onclick="closeModal('reportModal')">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <script>
// V√©rifier l'authentification
const token = localStorage.getItem('speakfree_token');
const admin = JSON.parse(localStorage.getItem('speakfree_admin') || '{}');

if (!token) {
    window.location.href = '/login';
}

// Afficher les infos de l'admin
document.getElementById('schoolName').textContent = admin.schoolName || '√âcole';
document.getElementById('adminName').textContent = `${admin.firstName || ''} ${admin.lastName || ''}`.trim() || 'Administrateur';

// Headers pour les requ√™tes API
const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
};

// Charger les donn√©es au d√©marrage
loadDashboardStats();
loadRecentReports();

// STATISTIQUES
function loadDashboardStats() {
    fetch('/api/admin/dashboard', { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                console.error('Erreur:', data.error);
                if (data.error.includes('Token')) logout();
                return;
            }
            document.getElementById('statTotal').textContent = data.total || 0;
            document.getElementById('statPending').textContent = data.pending || 0;
            document.getElementById('statInProgress').textContent = data.inProgress || 0;
            document.getElementById('statResolved').textContent = data.resolved || 0;
        })
        .catch(err => console.error('Erreur:', err));
}

// SIGNALEMENTS R√âCENTS
function loadRecentReports() {
    const container = document.getElementById('recentReportsList');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';

    fetch('/api/admin/reports?limit=5', { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error || !data.reports || data.reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì¢</div><h3>Aucun signalement</h3></div>';
                return;
            }
            container.innerHTML = data.reports.map(report => createReportCard(report)).join('');
        })
        .catch(err => {
            console.error('Erreur:', err);
            container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
        });
}

// CR√âER CARTE SIGNALEMENT
function createReportCard(report) {
    const statusClass = `status-${report.status || 'pending'}`;
    const statusText = {'pending': '‚è≥ En attente', 'in-progress': 'üîÑ En cours', 'resolved': '‚úÖ R√©solu'}[report.status] || '‚è≥ En attente';
    const typeClass = `type-${report.incident_type}`;
    const date = new Date(report.created_at).toLocaleDateString('fr-FR');
    const time = new Date(report.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

    return `
        <div class="report-card ${report.status === 'pending' ? 'urgent' : ''}" onclick="viewReportDetails(${report.id})">
            <div class="report-header">
                <div>
                    <div class="report-code">${report.tracking_code}</div>
                    <span class="report-type ${typeClass}">${report.incident_type || 'Autre'}</span>
                </div>
                <div class="report-date">${date} √† ${time}</div>
            </div>
            <div class="report-description">
                ${(report.description || '').substring(0, 150)}${report.description && report.description.length > 150 ? '...' : ''}
            </div>
            <div class="report-footer">
                <span class="status-badge ${statusClass}">${statusText}</span>
                <div class="action-btns">
                    <button class="btn btn-view" onclick="event.stopPropagation(); viewReportDetails(${report.id})">üëÅÔ∏è Voir</button>
                    <button class="btn btn-reply" onclick="event.stopPropagation(); viewReportDetails(${report.id})">üí¨ R√©pondre</button>
                </div>
            </div>
        </div>
    `;
}

// TOUS LES SIGNALEMENTS
function loadAllReports() {
    const container = document.getElementById('allReportsList');
    const statusFilter = document.getElementById('statusFilter').value;
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';

    let url = '/api/admin/reports?limit=100';
    if (statusFilter) url += `&status=${statusFilter}`;

    fetch(url, { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error || !data.reports || data.reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì¢</div><h3>Aucun signalement</h3></div>';
                return;
            }
            container.innerHTML = `<p style="color: #666; margin-bottom: 15px;"><strong>${data.reports.length}</strong> signalement(s)</p>` + data.reports.map(report => createReportCard(report)).join('');
        })
        .catch(err => {
            console.error('Erreur:', err);
            container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
        });
}

// D√âTAILS SIGNALEMENT
function viewReportDetails(reportId) {
    const modal = document.getElementById('reportModal');
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';
    modal.classList.add('active');

    fetch(`/api/admin/reports/${reportId}`, { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                modalBody.innerHTML = `<p style="color: red;">Erreur: ${data.error}</p>`;
                return;
            }

            const report = data.report;
            const files = data.files || [];
            const messages = data.messages || [];

            modalBody.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-label">Code</div><div class="detail-value">${report.tracking_code}</div></div>
                    <div class="detail-item"><div class="detail-label">Type</div><div class="detail-value">${report.incident_type}</div></div>
                    <div class="detail-item"><div class="detail-label">Date</div><div class="detail-value">${new Date(report.incident_date).toLocaleDateString('fr-FR')}</div></div>
                    <div class="detail-item"><div class="detail-label">Lieu</div><div class="detail-value">${report.location}</div></div>
                    <div class="detail-item"><div class="detail-label">T√©moins</div><div class="detail-value">${report.witnesses || 'Non sp√©cifi√©'}</div></div>
                    <div class="detail-item">
                        <div class="detail-label">Statut</div>
                        <div class="detail-value">
                            <select class="form-control" onchange="updateReportStatus(${report.id}, this.value)">
                                <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>En attente</option>
                                <option value="in-progress" ${report.status === 'in-progress' ? 'selected' : ''}>En cours</option>
                                <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>R√©solu</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <h3>Description</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">${report.description}</div>
                </div>
                ${files.length > 0 ? `<div class="files-list"><h3>Fichiers (${files.length})</h3>${files.map(f => `<div class="file-item"><span class="file-icon">${f.file_type.startsWith('image/') ? 'üñºÔ∏è' : 'üé•'}</span><div>${f.original_name}</div></div>`).join('')}</div>` : ''}
                ${messages.length > 0 ? `<div style="margin: 20px 0;"><h3>Discussion (${messages.length})</h3><div style="max-height: 300px; overflow-y: auto;">${messages.map(m => `<div style="padding: 10px; margin-bottom: 10px; background: ${m.sender_type === 'school' ? '#e3f2fd' : '#f8f9fa'}; border-radius: 8px;"><strong>${m.sender_type === 'school' ? 'üè´ √âcole' : 'üë§ √âl√®ve'}</strong> <small>${new Date(m.created_at).toLocaleString('fr-FR')}</small><p style="margin-top: 8px;">${m.message}</p></div>`).join('')}</div></div>` : ''}
                <div class="reply-form">
                    <h3>R√©pondre</h3>
                    <form onsubmit="sendReply(event, ${report.id})">
                        <div class="form-group"><textarea class="form-control" id="replyMessage" required></textarea></div>
                        <button type="submit" class="action-btn-primary">üì§ Envoyer</button>
                    </form>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <button class="btn btn-delete" onclick="deleteReport(${report.id})">üóëÔ∏è Supprimer</button>
                </div>
            `;
        })
        .catch(err => {
            console.error('Erreur:', err);
            modalBody.innerHTML = '<p style="color: red;">Erreur</p>';
        });
}

// METTRE √Ä JOUR STATUT
function updateReportStatus(reportId, newStatus) {
    fetch(`/api/admin/reports/${reportId}/status`, {
        method: 'PATCH',
        headers,
        body: JSON.stringify({ status: newStatus })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) alert('‚ùå ' + data.error);
        else { alert('‚úÖ Statut mis √† jour'); refreshData(); }
    })
    .catch(err => alert('‚ùå Erreur'));
}

// R√âPONDRE
function sendReply(event, reportId) {
    event.preventDefault();
    const message = document.getElementById('replyMessage').value;
    fetch(`/api/admin/reports/${reportId}/reply`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ message })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) alert('‚ùå ' + data.error);
        else { alert('‚úÖ Envoy√©'); document.getElementById('replyMessage').value = ''; viewReportDetails(reportId); }
    })
    .catch(err => alert('‚ùå Erreur'));
}

// SUPPRIMER
function deleteReport(reportId) {
    if (!confirm('‚ö†Ô∏è Supprimer ce signalement ?')) return;
    fetch(`/api/admin/reports/${reportId}`, { method: 'DELETE', headers })
        .then(res => res.json())
        .then(data => {
            if (data.error) alert('‚ùå ' + data.error);
            else { alert('‚úÖ Supprim√©'); closeModal('reportModal'); refreshData(); }
        })
        .catch(err => alert('‚ùå Erreur'));
}

// DISCUSSIONS
function loadDiscussions() {
    const container = document.getElementById('discussionsList');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';
    fetch('/api/admin/discussions', { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error || !data.discussions || data.discussions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üí¨</div><h3>Aucune discussion</h3></div>';
                return;
            }
            container.innerHTML = data.discussions.map(d => `
                <div class="report-card" onclick="viewReportDetails(${d.id})">
                    <div class="report-header">
                        <div><div class="report-code">${d.tracking_code}</div></div>
                        <div class="report-date">${new Date(d.last_message).toLocaleString('fr-FR')}</div>
                    </div>
                    <div class="report-footer">
                        <span>${d.message_count} message(s)</span>
                        <button class="btn btn-view" onclick="event.stopPropagation(); viewReportDetails(${d.id})">üí¨ Ouvrir</button>
                    </div>
                </div>
            `).join('');
        })
        .catch(err => {
            console.error('Erreur:', err);
            container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
        });
}

// STATISTIQUES
function loadStatistics() {
    const container = document.getElementById('statisticsContent');
    const period = document.getElementById('periodFilter').value;
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';
    fetch(`/api/admin/statistics?period=${period}`, { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
                return;
            }
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            if (data.byType && data.byType.length > 0) {
                html += `<div class="chart-container"><h3>üìä Par Type</h3>${data.byType.map(i => `<div style="margin: 10px 0;"><div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>${i.incident_type}</span><strong>${i.count}</strong></div><div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;"><div style="background: #667eea; height: 100%; width: ${(i.count / data.byType.reduce((a,b) => a + b.count, 0) * 100)}%;"></div></div></div>`).join('')}</div>`;
            }
            if (data.byStatus && data.byStatus.length > 0) {
                html += `<div class="chart-container"><h3>üìà Par Statut</h3>${data.byStatus.map(i => `<div style="margin: 10px 0;"><div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>${i.status}</span><strong>${i.count}</strong></div><div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;"><div style="background: ${i.status === 'resolved' ? '#28a745' : i.status === 'in-progress' ? '#17a2b8' : '#ffc107'}; height: 100%; width: ${(i.count / data.byStatus.reduce((a,b) => a + b.count, 0) * 100)}%;"></div></div></div>`).join('')}</div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        })
        .catch(err => {
            console.error('Erreur:', err);
            container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
        });
}

// √âQUIPE
function loadTeam() {
    const container = document.getElementById('teamList');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement...</p></div>';
    fetch('/api/admin/team', { headers })
        .then(res => res.json())
        .then(data => {
            if (data.error || !data.team || data.team.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><h3>Aucun membre</h3></div>';
                return;
            }
            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">${data.team.map(m => `<div class="detail-item" style="padding: 20px;"><div style="text-align: center; margin-bottom: 15px;"><div class="admin-avatar" style="margin: 0 auto;">üë§</div></div><h3 style="text-align: center; margin-bottom: 10px;">${m.first_name} ${m.last_name}</h3><p style="text-align: center; color: #666; margin-bottom: 15px;">${m.position}</p><div style="font-size: 0.9em;"><p>üìß ${m.email}</p><p>üìû ${m.phone}</p><p style="color: #999; margin-top: 10px;">Membre depuis ${new Date(m.created_at).toLocaleDateString('fr-FR')}</p></div></div>`).join('')}</div>`;
        })
        .catch(err => {
            console.error('Erreur:', err);
            container.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Erreur</h3></div>';
        });
}

// PARAM√àTRES
function loadSettings() {
    fetch(`/api/schools/${admin.schoolCode}`, { headers })
        .then(res => res.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('settingsSchoolCode').textContent = data.school_code;
                document.getElementById('settingsSchoolName').textContent = data.name;
                document.getElementById('settingsCity').textContent = data.city;
                document.getElementById('settingsStatus').textContent = data.status === 'active' ? 'Active' : 'Inactive';
            }
        })
        .catch(err => console.error('Erreur:', err));
}

// CHANGER MOT DE PASSE
function changePassword(event) {
    event.preventDefault();
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (newPassword !== confirmPassword) { alert('‚ùå Mots de passe diff√©rents'); return; }
    fetch('/api/auth/change-password', {
        method: 'POST',
        headers,
        body: JSON.stringify({ currentPassword, newPassword })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) alert('‚ùå ' + data.error);
        else { alert('‚úÖ Mot de passe chang√©'); document.getElementById('changePasswordForm').reset(); }
    })
    .catch(err => alert('‚ùå Erreur'));
}

// NAVIGATION
function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    event.target.closest('.menu-item').classList.add('active');
    const titles = {'dashboard': 'Tableau de Bord', 'reports': 'Tous les Signalements', 'discussions': 'Discussions', 'statistics': 'Statistiques', 'team': '√âquipe', 'settings': 'Param√®tres'};
    document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';
    if (sectionId === 'reports') loadAllReports();
    if (sectionId === 'discussions') loadDiscussions();
    if (sectionId === 'statistics') loadStatistics();
    if (sectionId === 'team') loadTeam();
    if (sectionId === 'settings') loadSettings();
}

// UTILITAIRES
function refreshData() { loadDashboardStats(); loadRecentReports(); if (document.getElementById('reports').classList.contains('active')) loadAllReports(); }
function filterReports() { loadAllReports(); }
function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
function logout() { if (confirm('D√©connexion ?')) { localStorage.removeItem('speakfree_token'); localStorage.removeItem('speakfree_admin'); window.location.href = '/login'; } }
window.onclick = function(event) { if (event.target.classList.contains('modal')) event.target.classList.remove('active'); }
    </script>
</body>
</html>