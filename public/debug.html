<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug SpeakFree</title>
    <script src="/config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #667eea; }
        .card { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5a6fd6; }
        .btn-danger { background: #dc3545; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #667eea; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug SpeakFree</h1>
        
        <div class="card">
            <h2>üìã Informations de session</h2>
            <div id="sessionInfo"></div>
        </div>

        <div class="card">
            <h2>üîç Actions de diagnostic</h2>
            <button class="btn" onclick="checkReports()">üì¢ Voir tous les signalements</button>
            <button class="btn" onclick="checkSchools()">üè´ Voir toutes les √©coles</button>
            <button class="btn" onclick="checkMyReports()">üìä Mes signalements (school_id=3)</button>
            <button class="btn btn-danger" onclick="fixSchoolId()">üîß Corriger school_id des signalements</button>
        </div>

        <div class="card">
            <h2>üìä R√©sultats</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('speakfree_token');
        const admin = JSON.parse(localStorage.getItem('speakfree_admin') || '{}');
        
        // Afficher infos session
        document.getElementById('sessionInfo').innerHTML = `
            <div class="info">
                <strong>Token:</strong> ${token ? '‚úÖ Pr√©sent' : '‚ùå Absent'}<br>
                <strong>Admin ID:</strong> ${admin.id || 'N/A'}<br>
                <strong>School ID:</strong> ${admin.schoolId || 'N/A'}<br>
                <strong>School Code:</strong> ${admin.schoolCode || 'N/A'}<br>
                <strong>School Name:</strong> ${admin.schoolName || 'N/A'}<br>
                <strong>Email:</strong> ${admin.email || 'N/A'}<br>
                <strong>API URL:</strong> ${CONFIG.API_URL}
            </div>
        `;

        async function checkReports() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Chargement...</p>';
            
            try {
                // R√©cup√©rer TOUS les signalements directement
                const res = await fetch(CONFIG.API_URL + '/api/admin/debug/all-reports', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                let html = '<div class="success">Votre school_id: <strong>' + data.yourSchoolId + '</strong></div>';
                
                if (data.reports && data.reports.length > 0) {
                    html += '<h3>üì¢ Tous les signalements (' + data.reports.length + ')</h3>';
                    html += '<table><tr><th>ID</th><th>School ID</th><th>School Name</th><th>School Code</th><th>Tracking</th><th>Type</th><th>Date</th></tr>';
                    data.reports.forEach(r => {
                        const highlight = r.school_id == data.yourSchoolId ? 'background: #c8e6c9;' : '';
                        html += `<tr style="${highlight}"><td>${r.id}</td><td>${r.school_id}</td><td>${r.school_name || 'N/A'}</td><td>${r.school_code || 'N/A'}</td><td>${r.tracking_code}</td><td>${r.incident_type}</td><td>${new Date(r.created_at).toLocaleString('fr-FR')}</td></tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<div class="error">Aucun signalement trouv√© dans la base de donn√©es</div>';
                }
                
                if (data.schools && data.schools.length > 0) {
                    html += '<h3>üè´ Toutes les √©coles (' + data.schools.length + ')</h3>';
                    html += '<table><tr><th>ID</th><th>Code</th><th>Nom</th><th>Statut</th></tr>';
                    data.schools.forEach(s => {
                        const highlight = s.id == data.yourSchoolId ? 'background: #c8e6c9;' : '';
                        html += `<tr style="${highlight}"><td>${s.id}</td><td>${s.school_code}</td><td>${s.name}</td><td>${s.status}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                results.innerHTML = html;
            } catch (err) {
                results.innerHTML = '<div class="error">Erreur: ' + err.message + '</div><pre>' + err.stack + '</pre>';
            }
        }

        async function checkSchools() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Chargement...</p>';
            
            try {
                const res = await fetch(CONFIG.API_URL + '/api/schools', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                let html = '<h3>üè´ √âcoles actives</h3>';
                if (data.schools && data.schools.length > 0) {
                    html += '<table><tr><th>ID</th><th>Code</th><th>Nom</th><th>Ville</th><th>Statut</th></tr>';
                    data.schools.forEach(s => {
                        html += `<tr><td>${s.id}</td><td>${s.school_code}</td><td>${s.name}</td><td>${s.city || 'N/A'}</td><td>${s.status}</td></tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<div class="error">Aucune √©cole trouv√©e</div>';
                }
                
                results.innerHTML = html;
            } catch (err) {
                results.innerHTML = '<div class="error">Erreur: ' + err.message + '</div>';
            }
        }

        async function checkMyReports() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Chargement...</p>';
            
            try {
                const res = await fetch(CONFIG.API_URL + '/api/admin/reports?limit=100', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                let html = '<h3>üìä Signalements pour votre √©cole (school_id=' + admin.schoolId + ')</h3>';
                html += '<div class="info">Debug info: ' + JSON.stringify(data.debug || {}) + '</div>';
                
                if (data.reports && data.reports.length > 0) {
                    html += '<table><tr><th>ID</th><th>Tracking</th><th>Type</th><th>Statut</th><th>Date</th></tr>';
                    data.reports.forEach(r => {
                        html += `<tr><td>${r.id}</td><td>${r.tracking_code}</td><td>${r.incident_type}</td><td>${r.status}</td><td>${new Date(r.created_at).toLocaleString('fr-FR')}</td></tr>`;
                    });
                    html += '</table>';
                } else {
                    html += '<div class="error">Aucun signalement pour school_id=' + admin.schoolId + '</div>';
                }
                
                results.innerHTML = html;
            } catch (err) {
                results.innerHTML = '<div class="error">Erreur: ' + err.message + '</div>';
            }
        }

        async function fixSchoolId() {
            if (!confirm('Cela va mettre √† jour tous les signalements pour les associer √† votre √©cole (school_id=3). Continuer?')) {
                return;
            }
            
            const results = document.getElementById('results');
            results.innerHTML = '<p>Correction en cours...</p>';
            
            try {
                const res = await fetch(CONFIG.API_URL + '/api/admin/fix-reports-school', {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targetSchoolId: 3 })
                });
                const data = await res.json();
                
                if (data.success) {
                    results.innerHTML = '<div class="success">‚úÖ ' + data.message + '<br>Signalements corrig√©s: ' + data.updated + '</div>';
                } else {
                    results.innerHTML = '<div class="error">‚ùå ' + (data.error || 'Erreur inconnue') + '</div>';
                }
            } catch (err) {
                results.innerHTML = '<div class="error">Erreur: ' + err.message + '</div>';
            }
        }
    </script>
</body>
</html>
