<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#c0392b">
    <link rel="stylesheet" href="/styles-mobile.css">
    <title>Super Admin - SpeakFree</title>
    <!-- Charger config.js en premier -->
    <script src="/config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #c0392b; min-height: 100vh; }
        
        /* LOGIN */
        #loginScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; }
        .login-box h1 { color: #c0392b; text-align: center; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: #c0392b; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        
        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5em; }
        .logout-btn { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; cursor: pointer; }
        
        /* STATS */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .num { font-size: 2em; color: #c0392b; font-weight: bold; }
        .stat-card .label { color: #666; }
        
        /* TABS */
        .main-panel { background: white; border-radius: 10px; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .tab-btn.active { background: #c0392b; color: white; }
        
        /* SCHOOL CARDS */
        .school-list { min-height: 200px; }
        .school-card { background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #c0392b; }
        .school-card h3 { margin-bottom: 5px; color: #333; }
        .school-card p { color: #666; font-size: 14px; margin-bottom: 10px; }
        .school-card .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .school-card .buttons button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-green { background: #27ae60; color: white; }
        .btn-yellow { background: #f39c12; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-blue { background: #3498db; color: white; }
        
        .empty { text-align: center; padding: 40px; color: #999; }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { color: #c0392b; margin-bottom: 20px; text-align: center; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .modal-content textarea { min-height: 200px; font-family: monospace; }
        .modal-content .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .modal-content .btn-row button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; }
        .btn-whatsapp { background: #25D366; color: white; font-weight: bold; }
        .btn-whatsapp:hover { background: #128C7E; }
        .btn-cancel { background: #e0e0e0; color: #333; }
        .btn-copy { background: #3498db; color: white; }
        .info-box { background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #27ae60; }
        .info-box p { margin: 5px 0; font-size: 14px; }
        .info-box strong { color: #27ae60; }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-box">
        <h1>‚öôÔ∏è Super Admin</h1>
        <p style="text-align:center; color:#666; margin-bottom:20px;">Acc√®s r√©serv√©</p>
        <input type="password" id="codeInput" placeholder="Code d'acc√®s..." />
        <button id="loginBtn">Connexion</button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="header">
        <h1>‚öôÔ∏è Super Admin Panel</h1>
        <button class="logout-btn" id="logoutBtn">D√©connexion</button>
    </div>
    
    <div class="stats">
        <div class="stat-card"><div class="num" id="statActive">0</div><div class="label">√âcoles Actives</div></div>
        <div class="stat-card"><div class="num" id="statPending">0</div><div class="label">En Attente</div></div>
        <div class="stat-card"><div class="num" id="statReports">0</div><div class="label">Signalements</div></div>
        <div class="stat-card"><div class="num" id="statAdmins">0</div><div class="label">Admins</div></div>
    </div>
    
    <div class="main-panel">
        <div class="tabs">
            <button class="tab-btn active" id="tabPending">‚è≥ En Attente</button>
            <button class="tab-btn" id="tabActive">‚úÖ Actives</button>
            <button class="tab-btn" id="tabInactive">‚è∏Ô∏è Inactives</button>
        </div>
        
        <div class="school-list" id="schoolList">
            <div class="loading">Chargement...</div>
        </div>
    </div>
</div>

<!-- MODAL APPROBATION -->
<div class="modal" id="approveModal">
    <div class="modal-content">
        <h2>‚úÖ Approuver l'√âcole</h2>
        
        <div id="approveStep1">
            <div class="school-info-box" id="schoolInfoBox" style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
                <p><strong>üè´ √âcole :</strong> <span id="modalSchoolName">-</span></p>
                <p><strong>üìû T√©l√©phone :</strong> <span id="modalSchoolPhone">-</span></p>
                <p><strong>üìß Email :</strong> <span id="modalSchoolEmail">-</span></p>
            </div>
            <p style="color:#666; margin-bottom:15px;">D√©finissez le mot de passe pour cette √©cole :</p>
            <input type="text" id="schoolPassword" placeholder="Mot de passe de l'√©cole..." style="font-size:18px;" />
            <div class="btn-row" style="margin-top:20px;">
                <button class="btn-cancel" id="btnCancelApprove">Annuler</button>
                <button class="btn-green" id="btnConfirmApprove">‚úÖ Approuver & Envoyer WhatsApp</button>
            </div>
        </div>
        
        <div id="approveStep2" style="display:none;">
            <div class="info-box" style="background:#d4edda; padding:15px; border-radius:10px; margin-bottom:15px;">
                <p>‚úÖ <strong>√âcole approuv√©e avec succ√®s !</strong></p>
            </div>
            
            <p style="color:#666; margin-bottom:10px;">Message WhatsApp :</p>
            <textarea id="whatsappMessage" readonly style="height:200px;"></textarea>
            
            <div class="btn-row" style="margin-top:15px;">
                <button class="btn-copy" id="btnCopyMessage">üìã Copier</button>
                <button class="btn-whatsapp" id="btnSendWhatsApp">üì± Envoyer WhatsApp</button>
            </div>
            <button class="btn-cancel" style="width:100%; margin-top:15px;" id="btnCloseModal">Fermer</button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // ===== CONFIGURATION =====
    // Utiliser config.js global
    var API = (typeof CONFIG !== 'undefined') ? CONFIG.API_URL : 'https://speakfree-m9xv.onrender.com';
    console.log('[SUPER-ADMIN] API URL:', API);
    
    var CODE = '200700';
    var currentTab = 'pending';
    
    // ===== ELEMENTS =====
    var loginScreen = document.getElementById('loginScreen');
    var dashboard = document.getElementById('dashboard');
    var codeInput = document.getElementById('codeInput');
    var loginBtn = document.getElementById('loginBtn');
    var logoutBtn = document.getElementById('logoutBtn');
    var schoolList = document.getElementById('schoolList');
    var tabPending = document.getElementById('tabPending');
    var tabActive = document.getElementById('tabActive');
    var tabInactive = document.getElementById('tabInactive');
    
    // ===== LOGIN =====
    loginBtn.onclick = function() {
        if (codeInput.value === CODE) {
            loginScreen.style.display = 'none';
            dashboard.style.display = 'block';
            loadStats();
            loadSchools('pending');
        } else {
            alert('Code incorrect');
        }
    };
    
    codeInput.onkeypress = function(e) {
        if (e.key === 'Enter') loginBtn.click();
    };
    
    logoutBtn.onclick = function() {
        dashboard.style.display = 'none';
        loginScreen.style.display = 'flex';
        codeInput.value = '';
    };
    
    // ===== TABS =====
    tabPending.onclick = function() { switchTab('pending', this); };
    tabActive.onclick = function() { switchTab('active', this); };
    tabInactive.onclick = function() { switchTab('inactive', this); };
    
    function switchTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        loadSchools(tab);
    }
    
    // ===== LOAD STATS =====
    function loadStats() {
        fetch(API + '/api/super-admin/stats')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                document.getElementById('statActive').textContent = d.activeSchools || 0;
                document.getElementById('statPending').textContent = d.pendingSchools || 0;
                document.getElementById('statReports').textContent = d.totalReports || 0;
                document.getElementById('statAdmins').textContent = d.totalAdmins || 0;
            })
            .catch(function(e) { console.error('Stats error:', e); });
    }
    
    // ===== LOAD SCHOOLS =====
    function loadSchools(type) {
        schoolList.innerHTML = '<div class="loading">Chargement...</div>';
        
        var url = API + '/api/super-admin/schools/' + type;
        
        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.schools || d.schools.length === 0) {
                    schoolList.innerHTML = '<div class="empty">Aucune √©cole</div>';
                    return;
                }
                
                var html = '';
                d.schools.forEach(function(s) {
                    html += createSchoolCard(s, type);
                });
                schoolList.innerHTML = html;
                
                // Attach events AFTER inserting HTML
                attachButtonEvents();
            })
            .catch(function(e) {
                console.error('Load error:', e);
                schoolList.innerHTML = '<div class="empty" style="color:red">Erreur: ' + e.message + '</div>';
            });
    }
    
    // ===== CREATE CARD HTML =====
    function createSchoolCard(school, type) {
        var buttons = '';
        
        if (type === 'pending') {
            buttons = '<button class="btn-green" data-action="approve" data-id="' + school.id + '">‚úÖ Approuver</button>' +
                      '<button class="btn-red" data-action="reject" data-id="' + school.id + '">‚ùå Rejeter</button>';
        } else if (type === 'active') {
            buttons = '<button class="btn-blue" data-action="details" data-id="' + school.id + '">üëÅÔ∏è D√©tails</button>' +
                      '<button class="btn-yellow" data-action="deactivate" data-id="' + school.id + '">‚è∏Ô∏è D√©sactiver</button>' +
                      '<button class="btn-red" data-action="delete" data-id="' + school.id + '">üóëÔ∏è Supprimer</button>';
        } else if (type === 'inactive') {
            buttons = '<button class="btn-green" data-action="activate" data-id="' + school.id + '">‚úÖ R√©activer</button>' +
                      '<button class="btn-red" data-action="delete" data-id="' + school.id + '">üóëÔ∏è Supprimer</button>';
        }
        
        return '<div class="school-card">' +
               '<h3>' + escapeHtml(school.name) + '</h3>' +
               '<p>Code: ' + escapeHtml(school.school_code) + ' | Ville: ' + escapeHtml(school.city || 'N/A') + '</p>' +
               '<div class="buttons">' + buttons + '</div>' +
               '</div>';
    }
    
    // ===== ATTACH BUTTON EVENTS =====
    function attachButtonEvents() {
        var buttons = schoolList.querySelectorAll('button[data-action]');
        
        buttons.forEach(function(btn) {
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                var action = this.getAttribute('data-action');
                var id = parseInt(this.getAttribute('data-id'));
                
                console.log('Button clicked:', action, id);
                
                switch(action) {
                    case 'approve': approveSchool(id); break;
                    case 'reject': rejectSchool(id); break;
                    case 'activate': activateSchool(id); break;
                    case 'deactivate': deactivateSchool(id); break;
                    case 'delete': deleteSchool(id); break;
                    case 'details': viewDetails(id); break;
                }
            };
        });
        
        console.log('Attached events to', buttons.length, 'buttons');
    }
    
    // ===== VARIABLES POUR LE MODAL =====
    var pendingApproveId = null;
    var pendingSchoolData = null;
    var pendingSchoolPhone = null;
    
    // ===== ATTACHER LES EVENTS DU MODAL =====
    document.getElementById('btnCancelApprove').onclick = closeApproveModal;
    document.getElementById('btnConfirmApprove').onclick = confirmApprove;
    document.getElementById('btnCopyMessage').onclick = copyMessage;
    document.getElementById('btnSendWhatsApp').onclick = sendWhatsApp;
    document.getElementById('btnCloseModal').onclick = closeApproveModal;
    
    // ===== MODAL FUNCTIONS =====
    function openApproveModal(id) {
        pendingApproveId = id;
        pendingSchoolData = null;
        pendingSchoolPhone = null;
        
        // Reset
        document.getElementById('schoolPassword').value = '';
        document.getElementById('modalSchoolName').textContent = 'Chargement...';
        document.getElementById('modalSchoolPhone').textContent = 'Chargement...';
        document.getElementById('modalSchoolEmail').textContent = 'Chargement...';
        document.getElementById('approveStep1').style.display = 'block';
        document.getElementById('approveStep2').style.display = 'none';
        document.getElementById('approveModal').classList.add('active');
        
        // R√©cup√©rer les infos de l'√©cole
        fetch(API + '/api/super-admin/schools/' + id + '/details')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            console.log('[MODAL] Donn√©es √©cole:', d);
            if (d.school) {
                pendingSchoolData = d.school;
                pendingSchoolPhone = d.school.phone || d.school.admin_phone || '';
                
                document.getElementById('modalSchoolName').textContent = d.school.name || '-';
                document.getElementById('modalSchoolPhone').textContent = pendingSchoolPhone || 'Non renseign√©';
                document.getElementById('modalSchoolEmail').textContent = d.school.email || d.school.admin_email || '-';
            }
        })
        .catch(function(e) {
            console.error('[MODAL] Erreur:', e);
        });
    }
    
    function closeApproveModal() {
        document.getElementById('approveModal').classList.remove('active');
        pendingApproveId = null;
        pendingSchoolData = null;
        pendingSchoolPhone = null;
        loadSchools(currentTab);
        loadStats();
    }
    
    function confirmApprove() {
        var pwd = document.getElementById('schoolPassword').value.trim();
        
        if (!pwd) {
            alert('‚ö†Ô∏è Veuillez entrer un mot de passe');
            return;
        }
        
        if (pwd.length < 4) {
            alert('‚ö†Ô∏è Le mot de passe doit contenir au moins 4 caract√®res');
            return;
        }
        
        // D√©sactiver le bouton pendant le traitement
        var btn = document.getElementById('btnConfirmApprove');
        btn.disabled = true;
        btn.textContent = '‚è≥ Approbation...';
        
        fetch(API + '/api/super-admin/schools/' + pendingApproveId + '/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE, defaultPassword: pwd })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            btn.disabled = false;
            btn.textContent = '‚úÖ Approuver & Envoyer WhatsApp';
            
            if (d.error) { 
                alert('‚ùå Erreur: ' + d.error); 
                return; 
            }
            
            // Pr√©parer le message WhatsApp
            var schoolName = pendingSchoolData ? pendingSchoolData.name : 'Votre √©cole';
            var schoolCode = pendingSchoolData ? pendingSchoolData.school_code : (d.school_code || 'CODE');
            
            var message = 'üéâ *BIENVENUE SUR SPEAKFREE !*\n\n';
            message += '‚úÖ Votre √©cole *' + schoolName + '* a √©t√© approuv√©e !\n\n';
            message += 'üìã *INFORMATIONS DE CONNEXION*\n';
            message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            message += 'üåê Site : https://speakfree.pages.dev\n';
            message += 'üîë Connexion : https://speakfree.pages.dev/login.html\n\n';
            message += 'üë§ *Identifiant* : ' + schoolCode + '\n';
            message += 'üîê *Mot de passe* : ' + pwd + '\n';
            message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
            message += 'üìå *COMMENT UTILISER SPEAKFREE ?*\n';
            message += '1Ô∏è‚É£ Connectez-vous avec les identifiants ci-dessus\n';
            message += '2Ô∏è‚É£ Acc√©dez √† votre tableau de bord\n';
            message += '3Ô∏è‚É£ G√©rez les signalements anonymes\n\n';
            message += 'üôè Merci de faire confiance √† SpeakFree !';
            
            document.getElementById('whatsappMessage').value = message;
            
            // Passer √† l'√©tape 2
            document.getElementById('approveStep1').style.display = 'none';
            document.getElementById('approveStep2').style.display = 'block';
            
            // Ouvrir WhatsApp automatiquement si on a le num√©ro
            if (pendingSchoolPhone) {
                setTimeout(function() {
                    sendWhatsApp();
                }, 500);
            }
        })
        .catch(function(e) { 
            btn.disabled = false;
            btn.textContent = '‚úÖ Approuver & Envoyer WhatsApp';
            alert('‚ùå Erreur: ' + e.message); 
        });
    }
    
    function copyMessage() {
        var textarea = document.getElementById('whatsappMessage');
        textarea.select();
        document.execCommand('copy');
        alert('‚úÖ Message copi√© !');
    }
    
    function sendWhatsApp() {
        var phone = pendingSchoolPhone ? pendingSchoolPhone.replace(/\D/g, '') : '';
        var message = document.getElementById('whatsappMessage').value;
        
        if (!phone) {
            phone = prompt('üì± Entrez le num√©ro WhatsApp (ex: 225XXXXXXXXXX):');
            if (!phone) return;
            phone = phone.replace(/\D/g, '');
        }
        
        // Ouvrir WhatsApp Web/App
        var url = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(message);
        window.open(url, '_blank');
    }
    
    // ===== ACTIONS =====
    function approveSchool(id) {
        openApproveModal(id);
    }
    
    function rejectSchool(id) {
        if (!confirm('Rejeter cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole rejet√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function activateSchool(id) {
        if (!confirm('R√©activer cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole r√©activ√©e !');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function deactivateSchool(id) {
        if (!confirm('D√©sactiver cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/deactivate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole d√©sactiv√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function deleteSchool(id) {
        if (!confirm('SUPPRIMER d√©finitivement cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole supprim√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function viewDetails(id) {
        fetch(API + '/api/super-admin/schools/' + id + '/details')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            var s = d.school;
            alert('D√âTAILS\n\nNom: ' + s.name + '\nCode: ' + s.school_code + '\nVille: ' + (s.city || 'N/A') + '\nAdmins: ' + d.admins.length + '\nSignalements: ' + d.recentReports.length);
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    // ===== UTILS =====
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    console.log('Super Admin script loaded successfully');
})();
</script>

</body>
</html>
