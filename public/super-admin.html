<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - SpeakFree</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #c0392b; min-height: 100vh; }
        
        /* LOGIN */
        #loginScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 350px; }
        .login-box h1 { color: #c0392b; text-align: center; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: #c0392b; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        
        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .header { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5em; }
        .logout-btn { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; cursor: pointer; }
        
        /* STATS */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card .num { font-size: 2em; color: #c0392b; font-weight: bold; }
        .stat-card .label { color: #666; }
        
        /* TABS */
        .main-panel { background: white; border-radius: 10px; padding: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .tab-btn.active { background: #c0392b; color: white; }
        
        /* SCHOOL CARDS */
        .school-list { min-height: 200px; }
        .school-card { background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #c0392b; }
        .school-card h3 { margin-bottom: 5px; color: #333; }
        .school-card p { color: #666; font-size: 14px; margin-bottom: 10px; }
        .school-card .buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .school-card .buttons button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-green { background: #27ae60; color: white; }
        .btn-yellow { background: #f39c12; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-blue { background: #3498db; color: white; }
        
        .empty { text-align: center; padding: 40px; color: #999; }
        .loading { text-align: center; padding: 20px; color: #666; }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-box">
        <h1>‚öôÔ∏è Super Admin</h1>
        <p style="text-align:center; color:#666; margin-bottom:20px;">Acc√®s r√©serv√©</p>
        <input type="password" id="codeInput" placeholder="Code d'acc√®s..." />
        <button id="loginBtn">Connexion</button>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="header">
        <h1>‚öôÔ∏è Super Admin Panel</h1>
        <button class="logout-btn" id="logoutBtn">D√©connexion</button>
    </div>
    
    <div class="stats">
        <div class="stat-card"><div class="num" id="statActive">0</div><div class="label">√âcoles Actives</div></div>
        <div class="stat-card"><div class="num" id="statPending">0</div><div class="label">En Attente</div></div>
        <div class="stat-card"><div class="num" id="statReports">0</div><div class="label">Signalements</div></div>
        <div class="stat-card"><div class="num" id="statAdmins">0</div><div class="label">Admins</div></div>
    </div>
    
    <div class="main-panel">
        <div class="tabs">
            <button class="tab-btn active" id="tabPending">‚è≥ En Attente</button>
            <button class="tab-btn" id="tabActive">‚úÖ Actives</button>
            <button class="tab-btn" id="tabInactive">‚è∏Ô∏è Inactives</button>
        </div>
        
        <div class="school-list" id="schoolList">
            <div class="loading">Chargement...</div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // ===== CONFIGURATION =====
    var API = 'http://localhost:3000';
    var CODE = '200700';
    var currentTab = 'pending';
    
    // ===== ELEMENTS =====
    var loginScreen = document.getElementById('loginScreen');
    var dashboard = document.getElementById('dashboard');
    var codeInput = document.getElementById('codeInput');
    var loginBtn = document.getElementById('loginBtn');
    var logoutBtn = document.getElementById('logoutBtn');
    var schoolList = document.getElementById('schoolList');
    var tabPending = document.getElementById('tabPending');
    var tabActive = document.getElementById('tabActive');
    var tabInactive = document.getElementById('tabInactive');
    
    // ===== LOGIN =====
    loginBtn.onclick = function() {
        if (codeInput.value === CODE) {
            loginScreen.style.display = 'none';
            dashboard.style.display = 'block';
            loadStats();
            loadSchools('pending');
        } else {
            alert('Code incorrect');
        }
    };
    
    codeInput.onkeypress = function(e) {
        if (e.key === 'Enter') loginBtn.click();
    };
    
    logoutBtn.onclick = function() {
        dashboard.style.display = 'none';
        loginScreen.style.display = 'flex';
        codeInput.value = '';
    };
    
    // ===== TABS =====
    tabPending.onclick = function() { switchTab('pending', this); };
    tabActive.onclick = function() { switchTab('active', this); };
    tabInactive.onclick = function() { switchTab('inactive', this); };
    
    function switchTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        loadSchools(tab);
    }
    
    // ===== LOAD STATS =====
    function loadStats() {
        fetch(API + '/api/super-admin/stats')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                document.getElementById('statActive').textContent = d.activeSchools || 0;
                document.getElementById('statPending').textContent = d.pendingSchools || 0;
                document.getElementById('statReports').textContent = d.totalReports || 0;
                document.getElementById('statAdmins').textContent = d.totalAdmins || 0;
            })
            .catch(function(e) { console.error('Stats error:', e); });
    }
    
    // ===== LOAD SCHOOLS =====
    function loadSchools(type) {
        schoolList.innerHTML = '<div class="loading">Chargement...</div>';
        
        var url = API + '/api/super-admin/schools/' + type;
        
        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(d) {
                if (!d.schools || d.schools.length === 0) {
                    schoolList.innerHTML = '<div class="empty">Aucune √©cole</div>';
                    return;
                }
                
                var html = '';
                d.schools.forEach(function(s) {
                    html += createSchoolCard(s, type);
                });
                schoolList.innerHTML = html;
                
                // Attach events AFTER inserting HTML
                attachButtonEvents();
            })
            .catch(function(e) {
                console.error('Load error:', e);
                schoolList.innerHTML = '<div class="empty" style="color:red">Erreur: ' + e.message + '</div>';
            });
    }
    
    // ===== CREATE CARD HTML =====
    function createSchoolCard(school, type) {
        var buttons = '';
        
        if (type === 'pending') {
            buttons = '<button class="btn-green" data-action="approve" data-id="' + school.id + '">‚úÖ Approuver</button>' +
                      '<button class="btn-red" data-action="reject" data-id="' + school.id + '">‚ùå Rejeter</button>';
        } else if (type === 'active') {
            buttons = '<button class="btn-blue" data-action="details" data-id="' + school.id + '">üëÅÔ∏è D√©tails</button>' +
                      '<button class="btn-yellow" data-action="deactivate" data-id="' + school.id + '">‚è∏Ô∏è D√©sactiver</button>' +
                      '<button class="btn-red" data-action="delete" data-id="' + school.id + '">üóëÔ∏è Supprimer</button>';
        } else if (type === 'inactive') {
            buttons = '<button class="btn-green" data-action="activate" data-id="' + school.id + '">‚úÖ R√©activer</button>' +
                      '<button class="btn-red" data-action="delete" data-id="' + school.id + '">üóëÔ∏è Supprimer</button>';
        }
        
        return '<div class="school-card">' +
               '<h3>' + escapeHtml(school.name) + '</h3>' +
               '<p>Code: ' + escapeHtml(school.school_code) + ' | Ville: ' + escapeHtml(school.city || 'N/A') + '</p>' +
               '<div class="buttons">' + buttons + '</div>' +
               '</div>';
    }
    
    // ===== ATTACH BUTTON EVENTS =====
    function attachButtonEvents() {
        var buttons = schoolList.querySelectorAll('button[data-action]');
        
        buttons.forEach(function(btn) {
            btn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                var action = this.getAttribute('data-action');
                var id = parseInt(this.getAttribute('data-id'));
                
                console.log('Button clicked:', action, id);
                
                switch(action) {
                    case 'approve': approveSchool(id); break;
                    case 'reject': rejectSchool(id); break;
                    case 'activate': activateSchool(id); break;
                    case 'deactivate': deactivateSchool(id); break;
                    case 'delete': deleteSchool(id); break;
                    case 'details': viewDetails(id); break;
                }
            };
        });
        
        console.log('Attached events to', buttons.length, 'buttons');
    }
    
    // ===== ACTIONS =====
    function approveSchool(id) {
        var pwd = prompt('Mot de passe pour cette √©cole ?');
        if (!pwd) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE, defaultPassword: pwd })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole approuv√©e !');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function rejectSchool(id) {
        if (!confirm('Rejeter cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole rejet√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function activateSchool(id) {
        if (!confirm('R√©activer cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/activate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole r√©activ√©e !');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function deactivateSchool(id) {
        if (!confirm('D√©sactiver cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id + '/deactivate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole d√©sactiv√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function deleteSchool(id) {
        if (!confirm('SUPPRIMER d√©finitivement cette √©cole ?')) return;
        
        fetch(API + '/api/super-admin/schools/' + id, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: CODE })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            alert('√âcole supprim√©e');
            loadSchools(currentTab);
            loadStats();
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    function viewDetails(id) {
        fetch(API + '/api/super-admin/schools/' + id + '/details')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            if (d.error) { alert('Erreur: ' + d.error); return; }
            var s = d.school;
            alert('D√âTAILS\n\nNom: ' + s.name + '\nCode: ' + s.school_code + '\nVille: ' + (s.city || 'N/A') + '\nAdmins: ' + d.admins.length + '\nSignalements: ' + d.recentReports.length);
        })
        .catch(function(e) { alert('Erreur: ' + e.message); });
    }
    
    // ===== UTILS =====
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    console.log('Super Admin script loaded successfully');
})();
</script>

</body>
</html>
