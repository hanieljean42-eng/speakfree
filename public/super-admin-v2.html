<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Super Admin V2 (Debug)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; margin-right: 5px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-blue { background: #007bff; }
        .btn-yellow { background: #ffc107; color: #333; }
        .school-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; background: #fff; }
        .school-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .school-name { font-size: 1.2em; font-weight: bold; }
        .tabs { margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 1.1em; }
        .tab.active { border-bottom: 3px solid #007bff; color: #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #debug-log { background: #333; color: #0f0; padding: 10px; margin-top: 20px; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h1>⚙️ Super Admin V2 (Mode Debug)</h1>
    <p>Utilisez cette version si la version principale ne fonctionne pas.</p>
    
    <div id="login-section">
        <h2>Connexion</h2>
        <input type="password" id="admin-code" placeholder="Code Super Admin (200700)" style="padding: 10px;">
        <button class="btn btn-blue" onclick="window.tryLogin()">Se connecter</button>
    </div>

    <div id="dashboard-section" style="display: none;">
        <div class="tabs">
            <button class="tab active" onclick="window.switchTab('active')">✅ Actives</button>
            <button class="tab" onclick="window.switchTab('inactive')">⏸️ Inactives</button>
            <button class="tab" onclick="window.switchTab('pending')">⏳ En Attente</button>
        </div>

        <div id="tab-active" class="tab-content active">Chargement...</div>
        <div id="tab-inactive" class="tab-content">Chargement...</div>
        <div id="tab-pending" class="tab-content">Chargement...</div>
    </div>

    <h3>Journal de Debug (Erreurs)</h3>
    <div id="debug-log"></div>
</div>

<script>
    // 1. Gestionnaire d'erreurs global
    window.onerror = function(msg, url, line, col, error) {
        log(`❌ ERREUR JS: ${msg}\nLigne: ${line}, Col: ${col}\nFichier: ${url}`);
        alert(`ERREUR CRITIQUE:\n${msg}\n\nVoir le journal en bas de page.`);
        return false;
    };

    function log(msg) {
        const div = document.getElementById('debug-log');
        const p = document.createElement('div');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        div.prepend(p);
        console.log(msg);
    }

    // 2. Configuration
    const API_URL = 'http://localhost:3000'; // Hardcoded pour être sûr
    const SUPER_ADMIN_CODE = '200700';

    log('Script chargé. API_URL: ' + API_URL);

    // 3. Fonctions Globales (attachées à window explicitement)
    
    window.tryLogin = function() {
        const code = document.getElementById('admin-code').value;
        if (code === SUPER_ADMIN_CODE) {
            log('Connexion réussie');
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            window.loadAllData();
        } else {
            alert('Code incorrect');
        }
    };

    window.switchTab = function(tabName) {
        log('Changement onglet: ' + tabName);
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.add('active');
        // Trouver le bouton correspondant (approximatif)
        const buttons = document.querySelectorAll('.tab');
        if(tabName === 'active') buttons[0].classList.add('active');
        if(tabName === 'inactive') buttons[1].classList.add('active');
        if(tabName === 'pending') buttons[2].classList.add('active');
    };

    window.loadAllData = function() {
        window.loadActiveSchools();
        window.loadInactiveSchools();
        window.loadPendingSchools();
    };

    // --- CHARGEMENT DES DONNÉES ---

    window.loadActiveSchools = function() {
        log('Chargement écoles actives...');
        fetch(`${API_URL}/api/super-admin/schools/active`)
            .then(res => res.json())
            .then(data => {
                log(`Actives reçues: ${data.schools ? data.schools.length : 0}`);
                const container = document.getElementById('tab-active');
                if (!data.schools || data.schools.length === 0) {
                    container.innerHTML = '<p>Aucune école active.</p>';
                    return;
                }
                
                let html = '';
                data.schools.forEach(school => {
                    html += `
                        <div class="school-card">
                            <div class="school-header">
                                <span class="school-name">${school.name} (ID: ${school.id})</span>
                                <span style="color: green;">Active</span>
                            </div>
                            <p>Ville: ${school.city || 'N/A'} | Code: ${school.school_code}</p>
                            <div>
                                <button class="btn btn-blue" onclick="window.viewDetails(${school.id})">Détails</button>
                                <button class="btn btn-yellow" onclick="window.deactivateSchool(${school.id})">Désactiver</button>
                                <button class="btn btn-red" onclick="window.deleteSchool(${school.id})">Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                log('Erreur loadActiveSchools: ' + err.message);
                document.getElementById('tab-active').innerHTML = '<p style="color:red">Erreur de chargement</p>';
            });
    };

    window.loadInactiveSchools = function() {
        log('Chargement écoles inactives...');
        fetch(`${API_URL}/api/super-admin/schools/inactive`)
            .then(res => res.json())
            .then(data => {
                log(`Inactives reçues: ${data.schools ? data.schools.length : 0}`);
                const container = document.getElementById('tab-inactive');
                if (!data.schools || data.schools.length === 0) {
                    container.innerHTML = '<p>Aucune école inactive.</p>';
                    return;
                }
                
                let html = '';
                data.schools.forEach(school => {
                    html += `
                        <div class="school-card">
                            <div class="school-header">
                                <span class="school-name">${school.name} (ID: ${school.id})</span>
                                <span style="color: gray;">Inactive</span>
                            </div>
                            <p>Ville: ${school.city || 'N/A'} | Code: ${school.school_code}</p>
                            <div>
                                <button class="btn btn-green" onclick="window.activateSchool(${school.id})">Réactiver</button>
                                <button class="btn btn-red" onclick="window.deleteSchool(${school.id})">Supprimer</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                log('Erreur loadInactiveSchools: ' + err.message);
                document.getElementById('tab-inactive').innerHTML = '<p style="color:red">Erreur de chargement</p>';
            });
    };

    window.loadPendingSchools = function() {
        log('Chargement écoles en attente...');
        fetch(`${API_URL}/api/super-admin/schools/pending`)
            .then(res => res.json())
            .then(data => {
                log(`En attente reçues: ${data.schools ? data.schools.length : 0}`);
                const container = document.getElementById('tab-pending');
                if (!data.schools || data.schools.length === 0) {
                    container.innerHTML = '<p>Aucune demande en attente.</p>';
                    return;
                }
                
                let html = '';
                data.schools.forEach(school => {
                    html += `
                        <div class="school-card">
                            <div class="school-header">
                                <span class="school-name">${school.name} (ID: ${school.id})</span>
                                <span style="color: orange;">En attente</span>
                            </div>
                            <p>Ville: ${school.city || 'N/A'} | Email: ${school.email}</p>
                            <div>
                                <button class="btn btn-green" onclick="window.approveSchool(${school.id})">Approuver</button>
                                <button class="btn btn-red" onclick="window.rejectSchool(${school.id})">Rejeter</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                log('Erreur loadPendingSchools: ' + err.message);
                document.getElementById('tab-pending').innerHTML = '<p style="color:red">Erreur de chargement</p>';
            });
    };

    // --- ACTIONS ---

    window.deactivateSchool = function(id) {
        log(`Tentative désactivation école ID: ${id}`);
        if (!confirm('Voulez-vous vraiment désactiver cette école ?')) return;

        fetch(`${API_URL}/api/super-admin/schools/${id}/deactivate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: SUPER_ADMIN_CODE })
        })
        .then(res => res.json())
        .then(data => {
            log('Réponse désactivation: ' + JSON.stringify(data));
            if (data.error) alert('Erreur: ' + data.error);
            else {
                alert('Succès: ' + data.message);
                window.loadAllData();
            }
        })
        .catch(err => {
            log('Erreur fetch désactivation: ' + err.message);
            alert('Erreur réseau');
        });
    };

    window.activateSchool = function(id) {
        log(`Tentative activation école ID: ${id}`);
        if (!confirm('Voulez-vous vraiment réactiver cette école ?')) return;

        fetch(`${API_URL}/api/super-admin/schools/${id}/activate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: SUPER_ADMIN_CODE })
        })
        .then(res => res.json())
        .then(data => {
            log('Réponse activation: ' + JSON.stringify(data));
            if (data.error) alert('Erreur: ' + data.error);
            else {
                alert('Succès: ' + data.message);
                window.loadAllData();
            }
        })
        .catch(err => {
            log('Erreur fetch activation: ' + err.message);
            alert('Erreur réseau');
        });
    };

    window.deleteSchool = function(id) {
        log(`Tentative suppression école ID: ${id}`);
        if (!confirm('ATTENTION: Suppression définitive ! Continuer ?')) return;

        fetch(`${API_URL}/api/super-admin/schools/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: SUPER_ADMIN_CODE })
        })
        .then(res => res.json())
        .then(data => {
            log('Réponse suppression: ' + JSON.stringify(data));
            if (data.error) alert('Erreur: ' + data.error);
            else {
                alert('Succès: ' + data.message);
                window.loadAllData();
            }
        })
        .catch(err => {
            log('Erreur fetch suppression: ' + err.message);
            alert('Erreur réseau');
        });
    };

    window.viewDetails = function(id) {
        log(`Voir détails ID: ${id}`);
        fetch(`${API_URL}/api/super-admin/schools/${id}/details`)
            .then(res => res.json())
            .then(data => {
                log('Détails reçus');
                alert(JSON.stringify(data, null, 2));
            })
            .catch(err => alert('Erreur: ' + err.message));
    };

    window.approveSchool = function(id) {
        const pwd = prompt("Mot de passe pour l'école ?");
        if(!pwd) return;

        fetch(`${API_URL}/api/super-admin/schools/${id}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: SUPER_ADMIN_CODE, defaultPassword: pwd })
        })
        .then(res => res.json())
        .then(data => {
            if(data.error) alert(data.error);
            else {
                alert('Approuvé!');
                window.loadAllData();
            }
        });
    };

    window.rejectSchool = function(id) {
        if(!confirm('Rejeter ?')) return;
        fetch(`${API_URL}/api/super-admin/schools/${id}/reject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: SUPER_ADMIN_CODE })
        })
        .then(res => res.json())
        .then(data => {
            if(data.error) alert(data.error);
            else {
                alert('Rejeté!');
                window.loadAllData();
            }
        });
    };

</script>

</body>
</html>
